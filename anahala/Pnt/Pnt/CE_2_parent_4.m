N = 7;

nodes= [1 2 3 4 5 6 7 ];

node_sizes= [3 2 3 2 3 2 3 ];

dag=zeros(N,N);

dag=[0     1     1     0     1     1     1          
     0     0     1     0     0     1     1          
     0     0     0     1     1     0     0          
     0     0     0     0     1     0     1          
     0     0     0     0     0     0     1          
     0     0     0     0     0     0     0          
     0     0     0     0     0     0     0]; 
  
  pnet = mk_pnet(dag, node_sizes, nodes);
  
names = {'1' ,    '2',     '3' ,    '4' , '5', '6', '7'}; 
carre_rond = [1 1 1 1 1 1 1 ]; 
draw_layout(pnet.dag,names,carre_rond);


pnet.CPD{1} = tabular_CPD(pnet, 1,[1.0000    0.8176    0.7123]); 
pnet.CPD{2} = tabular_CPD(pnet, 2,[ 0.2498    1.0000    0.4632    1.0000    0.8378    1.0000]); 
pnet.CPD{3} = tabular_CPD(pnet, 3,[0.2071    1.0000    0.3034    1.0000         0    1.0000    1.0000    0.4817    1.0000         0    1.0000    0.7157    0.2960    0.4901 0.4861    0.9563    0.4103    0.2083]); 
pnet.CPD{4} = tabular_CPD(pnet, 4,[0.9118    1.0000    0.6482    1.0000    0.2143    1.0000]); 
pnet.CPD{5} = tabular_CPD(pnet, 5,[0.1870    1.0000    0.2276    1.0000    0.2136    1.0000         0    1.0000    0.8828    1.0000    0.8188    1.0000         0    1.0000 0.3611    1.0000    0.9729    1.0000    1.0000    0.2101    1.0000    0.7903    1.0000    0.4914    1.0000    0.9275    1.0000    0.6492  1.0000         0    1.0000         0    1.0000    0.5578    1.0000    0.6768    0.5250    0.9444    0.5457    0.8072    0.6319    0.9011  0.6734         0    0.9044    0.6364    0.4721         0    0.7498    0.2742    0.6663    0.6162    0.5504    0.6811]); 
pnet.CPD{6} = tabular_CPD(pnet, 6,[0.6927    1.0000    0.8348    1.0000    0.4603    1.0000    1.0000    0.8384    1.0000    0.2366    1.0000    0.8756]); 
pnet.CPD{7} = tabular_CPD(pnet, 7,[0.7879    1.0000    0.7741    1.0000    0.3783    1.0000    0.4862    1.0000    0.9294    1.0000    0.5106    1.0000         0    1.0000  0.3860    1.0000    0.9883    1.0000    0.4737    1.0000    0.7140    1.0000         0    1.0000    0.7357    1.0000    0.6654    1.0000  0.7167    1.0000    0.3505    1.0000    0.8070    1.0000    0.5670    1.0000    1.0000    0.2083    1.0000    0.4058    1.0000    0.6213  1.0000    0.6638    1.0000    0.6905    1.0000    0.9366    1.0000         0    1.0000    0.7250    1.0000    0.2231    1.0000    0.7047  1.0000    0.8289    1.0000         0    1.0000    0.4883    1.0000    0.3332    1.0000    0.3182    1.0000    0.3835    1.0000    0.8068  1.0000    0.2318    0.3432    0.4426    0.6790    0.6453    0.2423    0.5202    0.3654    0.6806    0.6128    0.2109    0.3302    0.8063  0.8255    0.9516    0.6501    0.3635    0.6444         0         0    0.5519         0    0.1560    0.7290    0.5658         0    0.4160  0.8392         0    0.4123         0    0.2686    0.4951         0    0.5608    0.9076    0.4810]); 

evidence = cell(1,N);

evidence{1} = 2;  
evidence{6} = 2;  
var_interest= 7;
instance_interest=3;
evidence_new=evidence;
evidence_new{var_interest} = instance_interest;  


disp('----------------new 1-------------');
engine = MG_inf_engine(pnet);
tic; [Bel_Cdt_new] = global_propagation(engine, evidence, var_interest, instance_interest, 0, 2); t1=toc;
Bel_Cdt=Bel_Cdt_new

disp('----------------junction-------------');
engine = jtree_inf_engine(pnet);
tic; [engine] = global_propagation(engine, evidence); t2=toc;
marg = marginal_nodes(engine, var_interest);
BEL_Cdt_classique=marg.T(instance_interest)

if ~isequal(Bel_Cdt, BEL_Cdt_classique)
    
   nah

end
